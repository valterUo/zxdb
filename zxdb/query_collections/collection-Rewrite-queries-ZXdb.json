{
  "version": 1,
  "type": "collection",
  "title": "Rewrite queries - ZXdb",
  "items": [
    {
      "title": "Hadamard edge cancellation",
      "description": "",
      "query": {
        "code": {
          "value": "// Find all marked patterns\r\nMATCH (s)\r\nWHERE s.pattern_id IS NOT NULL\r\n\r\n// Reconstruct the full path for each pattern\r\nWITH DISTINCT s.pattern_id AS pattern_id\r\nMATCH path = (start)-[:Wire*2..6]-(end)\r\nWHERE ALL(edge IN relationships(path) WHERE edge.pattern_id = pattern_id)\r\nAND start.pattern_id IS NULL AND end.pattern_id IS NULL AND id(start) < id(end)\r\n\r\nWITH start, end, pattern_id,\r\n      [node IN nodes(path)[1..-1] WHERE node.pattern_id = pattern_id] as nodes_to_delete\r\n\r\n// Create direct connection\r\nWITH DISTINCT start, end, nodes_to_delete, pattern_id\r\nCREATE (start)-[newWire:Wire {t: 1}]->(end)\r\n\r\n// Delete the nodes with the corresponding Hadamard edges\r\nWITH nodes_to_delete, pattern_id\r\nUNWIND nodes_to_delete AS node\r\nDETACH DELETE node\r\n\r\n// Return something to ensure changes were made\r\nWITH pattern_id\r\nRETURN COUNT(DISTINCT pattern_id) as patterns_processed"
        },
        "params": {}
      },
      "style": {
        "code": {
          "value": "// A palette of colors used to color distinct node labels\nDefine(COLOR_PALETTE, AsArray(\n  #DD2222, #FB6E00, #FFC500, #720096,\n  #5E4FA2, #3288BD, #66C2A5, #ABDDA4,\n  #E6F598, #FEE08B, #D53E4F, #9E0142\n))\nDefine(COLOR_PALETTE_ITER, AsIterator(COLOR_PALETTE))\n\n// If there are no palette colors to use, use random colors instead\nDefine(RandomColor, Function(RGB(RandomInt(255), RandomInt(255), RandomInt(255))))\nDefine(GetNextColor, Function(\n  Coalesce(Next(COLOR_PALETTE_ITER), RandomColor())\n))\n\n// Cache map to keep a selected color for each node label\nDefine(ColorByLabel, AsMap())\nDefine(GetColorByLabel, Function(labels, Coalesce(\n  Get(ColorByLabel, labels),\n  Set(ColorByLabel, labels, GetNextColor())\n)))\nDefine(JoinLabels, Function(labels, Join(Sort(labels), \":\")))\n\n// Baseline node style that will be applied to every single node\n@NodeStyle {\n  Define(COLOR, GetColorByLabel(JoinLabels(Labels(node))))\n\n  size: 6\n  color: COLOR\n  color-hover: Lighter(COLOR)\n  color-selected: Darker(COLOR)\n  border-width: 0.6\n  border-color: #1D1D1D\n  font-size: 3\n  font-color: #1D1D1D\n}\n\n// Overwrite node text with the node label if defined\n@NodeStyle Greater(Size(Labels(node)), 0) {\n  label: Format(\":{}\", Join(Labels(node), \" :\"))\n}\n\n// Overwrite node text with the property \"name\" if defined\n@NodeStyle HasProperty(node, \"name\") {\n  label: AsText(Property(node, \"name\"))\n}\n\n// Feel free to uncomment the lines below to set up a custom style for the specific node label\n// @NodeStyle HasLabel(node, \"MyCustomLabel\") {\n//   color: black\n// }\n\n// Feel free to uncomment the lines below to set up a custom style for the specific node property\n// @NodeStyle HasProperty(node, \"my_property_name\") {\n//   color: black\n//   label: AsText(Property(node, \"my_property_name\"))\n// }\n\nDefine(LATITUDE_FIELD, \"lat\")\nDefine(LONGITUDE_FIELD, \"lng\")\n\n// In the case of numeric latitude and longitude properties, set them up for a switch to a map view\n@NodeStyle And(IsNumber(Property(node, LATITUDE_FIELD)), IsNumber(Property(node, LONGITUDE_FIELD))) {\n  latitude: Property(node, LATITUDE_FIELD)\n  longitude: Property(node, LONGITUDE_FIELD)\n}\n\n// Baseline edge style that will be applied to every single edge\n@EdgeStyle {\n  color: #999999\n  color-hover: #1D1D1D\n  color-selected: #1D1D1D\n  width: 0.3\n  width-hover: 0.9\n  width-selected: 0.9\n  font-size: 3\n  font-color: #1D1D1D\n}\n\n// Show edge text only if there is a small number of edges in the view\n@EdgeStyle Less(EdgeCount(graph), 30) {\n  label: Type(edge)\n}\n\n// In case of a map view, set the default tile layer\n@ViewStyle.Map {\n  tile-layer: \"light\"\n}\n\n// Canvas background color\n@ViewStyle {\n  background-color: #FFFFFF00\n}\n"
        },
        "title": "System Style"
      }
    },
    {
      "title": "Spider fusion rewrite",
      "description": "",
      "query": {
        "code": {
          "value": "CALL {\r\n// Find all marked patterns\r\nMATCH ()-[s:Wire]-()\r\nWHERE s.pattern_id IS NOT NULL\r\n\r\n// Reconstruct the full path for each pattern\r\nWITH DISTINCT s.pattern_id AS pattern_id\r\nMATCH path = (start)-[:Wire*0..4]-(end)\r\nWHERE ALL(edge IN relationships(path) WHERE edge.pattern_id = pattern_id)\r\n  AND id(start) < id(end)\r\n  AND start.start_node = True \r\n  AND end.end_node = True\r\n\r\nWITH start, end, path, pattern_id,\r\n     nodes(path) as path_nodes,\r\n     relationships(path) as path_edges\r\n\r\n// Calculate sum of phases from all nodes in the path\r\nWITH start, end, path_nodes, path_edges, pattern_id,\r\n     reduce(phase_sum = 0, node IN path_nodes | phase_sum + coalesce(node.phase, 0)) as total_phase\r\n\r\n// Find all external edges connected to any node in the path (excluding path edges)\r\nMATCH (external)-[ext_edge:Wire]-(path_node)\r\nWHERE path_node IN path_nodes\r\n  AND NOT external IN path_nodes\r\n  AND NOT ext_edge IN path_edges\r\n\r\n// Collect all data needed before any modifications\r\nWITH start, path_nodes, path_edges, total_phase, pattern_id,\r\n     COLLECT(DISTINCT {\r\n       external_node: external,\r\n       edge_type: ext_edge.t,\r\n       connected_to: path_node,\r\n       edge_props: properties(ext_edge)\r\n     }) as external_connections\r\n\r\n// Update start node with summed phase (non-destructive operation)\r\nSET start.phase = total_phase % 2\r\n\r\n// Create all new external connections BEFORE deleting anything\r\nWITH start, path_nodes, external_connections, total_phase, pattern_id, path_edges\r\nUNWIND external_connections AS conn\r\nWITH start, conn.external_node as external, conn.edge_type as edge_type, \r\n     conn.edge_props as edge_props, total_phase, pattern_id, path_nodes, path_edges\r\n\r\n// Remove existing connections between start and external\r\nOPTIONAL MATCH (start)-[existing_edge:Wire]-(external)\r\nDELETE existing_edge\r\n\r\n// Create one edge for each original (path_node)-[]-(external) connection\r\nCREATE (start)-[new_edge:Wire]->(external)\r\nSET new_edge = edge_props, \r\n    new_edge.t = edge_type,\r\n    new_edge.connection_count = pattern_id\r\n\r\n// Collect all the data we need for deletion after all creations are done\r\nWITH start, path_nodes, total_phase, pattern_id, path_edges,\r\n     COUNT(DISTINCT external) as connections_created\r\n\r\n// Delete all path nodes except start\r\nWITH start, path_nodes, total_phase, pattern_id, connections_created\r\nUNWIND [node IN path_nodes WHERE node <> start] AS node_to_delete\r\nDETACH DELETE node_to_delete\r\n\r\n// Return results\r\nWITH DISTINCT pattern_id, total_phase, connections_created\r\nRETURN COUNT(DISTINCT pattern_id) as patterns_processed, \r\n       COLLECT(DISTINCT total_phase) as summed_phases,\r\n       SUM(connections_created) as total_connections_created\r\n}\r\n\r\nRETURN patterns_processed"
        },
        "params": {}
      },
      "style": {
        "code": {
          "value": "// A palette of colors used to color distinct node labels\nDefine(COLOR_PALETTE, AsArray(\n  #DD2222, #FB6E00, #FFC500, #720096,\n  #5E4FA2, #3288BD, #66C2A5, #ABDDA4,\n  #E6F598, #FEE08B, #D53E4F, #9E0142\n))\nDefine(COLOR_PALETTE_ITER, AsIterator(COLOR_PALETTE))\n\n// If there are no palette colors to use, use random colors instead\nDefine(RandomColor, Function(RGB(RandomInt(255), RandomInt(255), RandomInt(255))))\nDefine(GetNextColor, Function(\n  Coalesce(Next(COLOR_PALETTE_ITER), RandomColor())\n))\n\n// Cache map to keep a selected color for each node label\nDefine(ColorByLabel, AsMap())\nDefine(GetColorByLabel, Function(labels, Coalesce(\n  Get(ColorByLabel, labels),\n  Set(ColorByLabel, labels, GetNextColor())\n)))\nDefine(JoinLabels, Function(labels, Join(Sort(labels), \":\")))\n\n// Baseline node style that will be applied to every single node\n@NodeStyle {\n  Define(COLOR, GetColorByLabel(JoinLabels(Labels(node))))\n\n  size: 6\n  color: COLOR\n  color-hover: Lighter(COLOR)\n  color-selected: Darker(COLOR)\n  border-width: 0.6\n  border-color: #1D1D1D\n  font-size: 3\n  font-color: #1D1D1D\n}\n\n// Overwrite node text with the node label if defined\n@NodeStyle Greater(Size(Labels(node)), 0) {\n  label: Format(\":{}\", Join(Labels(node), \" :\"))\n}\n\n// Overwrite node text with the property \"name\" if defined\n@NodeStyle HasProperty(node, \"name\") {\n  label: AsText(Property(node, \"name\"))\n}\n\n// Feel free to uncomment the lines below to set up a custom style for the specific node label\n// @NodeStyle HasLabel(node, \"MyCustomLabel\") {\n//   color: black\n// }\n\n// Feel free to uncomment the lines below to set up a custom style for the specific node property\n// @NodeStyle HasProperty(node, \"my_property_name\") {\n//   color: black\n//   label: AsText(Property(node, \"my_property_name\"))\n// }\n\nDefine(LATITUDE_FIELD, \"lat\")\nDefine(LONGITUDE_FIELD, \"lng\")\n\n// In the case of numeric latitude and longitude properties, set them up for a switch to a map view\n@NodeStyle And(IsNumber(Property(node, LATITUDE_FIELD)), IsNumber(Property(node, LONGITUDE_FIELD))) {\n  latitude: Property(node, LATITUDE_FIELD)\n  longitude: Property(node, LONGITUDE_FIELD)\n}\n\n// Baseline edge style that will be applied to every single edge\n@EdgeStyle {\n  color: #999999\n  color-hover: #1D1D1D\n  color-selected: #1D1D1D\n  width: 0.3\n  width-hover: 0.9\n  width-selected: 0.9\n  font-size: 3\n  font-color: #1D1D1D\n}\n\n// Show edge text only if there is a small number of edges in the view\n@EdgeStyle Less(EdgeCount(graph), 30) {\n  label: Type(edge)\n}\n\n// In case of a map view, set the default tile layer\n@ViewStyle.Map {\n  tile-layer: \"light\"\n}\n\n// Canvas background color\n@ViewStyle {\n  background-color: #FFFFFF00\n}\n"
        },
        "title": "System Style"
      }
    },
    {
      "title": "Fix",
      "description": "",
      "query": {
        "code": {
          "value": "CALL {\r\n\r\n// Find two end nodes that are connected and have different pattern_ids\r\nMATCH (end1 {end_node: true})-[e:Wire]-(end2 {end_node: true})\r\nWHERE end1.pattern_id IS NOT NULL \r\n  AND end2.pattern_id IS NOT NULL\r\n  AND end1.pattern_id <> end2.pattern_id\r\n  AND id(end1) < id(end2)  // Process each pair only once\r\n\r\n// Find their corresponding start nodes\r\nMATCH (start1 {start_node: true, pattern_id: end1.pattern_id})\r\nMATCH (start2 {start_node: true, pattern_id: end2.pattern_id})\r\n\r\n// Create edge between the start nodes (if it doesn't already exist)\r\nMERGE (start1)-[new_edge:Wire]-(start2)\r\nON CREATE SET new_edge.t = 1, new_edge.graph_id = e.graph_id\r\n\r\nRETURN COUNT(*) as start_connections_created\r\n\r\n}\r\n\r\nCALL {\r\n// Find all node pairs that have edges with connection_count\r\nMATCH (a)-[edge:Wire]-(b)\r\nWHERE edge.connection_count IS NOT NULL \r\n  AND a.t = 1 \r\n  AND b.t = 2 \r\n  AND a.start_node = True \r\n  AND b.start_node = True\r\n\r\n// Sum connection counts for each node pair\r\nWITH a, b, MIN(edge.connection_count) as total_count\r\n// Now find ALL edges between these nodes (including those without connection_count)\r\nMATCH (a)-[all_edges:Wire]-(b)\r\n\r\nWITH a, b, total_count, COLLECT(all_edges) as all_edges_to_delete,\r\n     HEAD(COLLECT(all_edges.t)) as edge_type\r\n\r\n// Delete ALL edges between these nodes\r\nUNWIND all_edges_to_delete as edge\r\nDELETE edge\r\n\r\n// Create one directed edge only if total connection_count is odd\r\nWITH a, b, total_count, edge_type\r\nWHERE total_count % 2 = 1\r\n\r\nCREATE (a)-[new_edge:Wire]->(b)\r\nSET new_edge.t = edge_type\r\n\r\nRETURN COUNT(*) as pairs_processed\r\n}"
        },
        "params": {}
      },
      "style": {
        "code": {
          "value": "// A palette of colors used to color distinct node labels\nDefine(COLOR_PALETTE, AsArray(\n  #DD2222, #FB6E00, #FFC500, #720096,\n  #5E4FA2, #3288BD, #66C2A5, #ABDDA4,\n  #E6F598, #FEE08B, #D53E4F, #9E0142\n))\nDefine(COLOR_PALETTE_ITER, AsIterator(COLOR_PALETTE))\n\n// If there are no palette colors to use, use random colors instead\nDefine(RandomColor, Function(RGB(RandomInt(255), RandomInt(255), RandomInt(255))))\nDefine(GetNextColor, Function(\n  Coalesce(Next(COLOR_PALETTE_ITER), RandomColor())\n))\n\n// Cache map to keep a selected color for each node label\nDefine(ColorByLabel, AsMap())\nDefine(GetColorByLabel, Function(labels, Coalesce(\n  Get(ColorByLabel, labels),\n  Set(ColorByLabel, labels, GetNextColor())\n)))\nDefine(JoinLabels, Function(labels, Join(Sort(labels), \":\")))\n\n// Baseline node style that will be applied to every single node\n@NodeStyle {\n  Define(COLOR, GetColorByLabel(JoinLabels(Labels(node))))\n\n  size: 6\n  color: COLOR\n  color-hover: Lighter(COLOR)\n  color-selected: Darker(COLOR)\n  border-width: 0.6\n  border-color: #1D1D1D\n  font-size: 3\n  font-color: #1D1D1D\n}\n\n// Overwrite node text with the node label if defined\n@NodeStyle Greater(Size(Labels(node)), 0) {\n  label: Format(\":{}\", Join(Labels(node), \" :\"))\n}\n\n// Overwrite node text with the property \"name\" if defined\n@NodeStyle HasProperty(node, \"name\") {\n  label: AsText(Property(node, \"name\"))\n}\n\n// Feel free to uncomment the lines below to set up a custom style for the specific node label\n// @NodeStyle HasLabel(node, \"MyCustomLabel\") {\n//   color: black\n// }\n\n// Feel free to uncomment the lines below to set up a custom style for the specific node property\n// @NodeStyle HasProperty(node, \"my_property_name\") {\n//   color: black\n//   label: AsText(Property(node, \"my_property_name\"))\n// }\n\nDefine(LATITUDE_FIELD, \"lat\")\nDefine(LONGITUDE_FIELD, \"lng\")\n\n// In the case of numeric latitude and longitude properties, set them up for a switch to a map view\n@NodeStyle And(IsNumber(Property(node, LATITUDE_FIELD)), IsNumber(Property(node, LONGITUDE_FIELD))) {\n  latitude: Property(node, LATITUDE_FIELD)\n  longitude: Property(node, LONGITUDE_FIELD)\n}\n\n// Baseline edge style that will be applied to every single edge\n@EdgeStyle {\n  color: #999999\n  color-hover: #1D1D1D\n  color-selected: #1D1D1D\n  width: 0.3\n  width-hover: 0.9\n  width-selected: 0.9\n  font-size: 3\n  font-color: #1D1D1D\n}\n\n// Show edge text only if there is a small number of edges in the view\n@EdgeStyle Less(EdgeCount(graph), 30) {\n  label: Type(edge)\n}\n\n// In case of a map view, set the default tile layer\n@ViewStyle.Map {\n  tile-layer: \"light\"\n}\n\n// Canvas background color\n@ViewStyle {\n  background-color: #FFFFFF00\n}\n"
        },
        "title": "System Style"
      }
    }
  ]
}